require 'rubygems'
require 'active_record'

task :default do
  exec "rake -T"
end

desc "Run Development Server"
task :run_dev do
  # https://github.com/postrank-labs/goliath/wiki/Server
  system "ruby piecemaker.rb --port 9080 \
                             --environment dev \
                             --log log/log.txt \
                             --stdout"
end

desc "Run Production Server"
task :run_prod do
  # https://github.com/postrank-labs/goliath/wiki/Server
  system "ruby piecemaker.rb --port 9080 \
                             --environment prod \
                             --log log/log.txt"
end

desc "run apache ab benchmarking"
task :ab_benchmark do
  # http://httpd.apache.org/docs/2.2/programs/ab.html
  system "ab -c 3 -n 5000 http://127.0.0.1:9080/v1/users"
end



desc "Migrate the database through scripts in db/migrate."
task :migrate, :version do |t, args|

  # @todo: refactor this. work-around for loading test env config
  def environment(env, &blk)
    if env == :test
      blk.call
    end
  end
  require './config/piecemaker.rb'
  ActiveRecord::Base.logger = Logger.new(File.open('log/spec_database.log', 'a+'))
  ActiveRecord::Migrator.migrate('db/migrate', args[:version] ? args[:version].to_i : nil )
end


desc "run tests"
task :test do
  system "rspec spec/*"
end

